pipeline {
    agent any

    environment {
        // Secrets managed by Jenkins credentials
        EPUB_READWISE_TOKEN = credentials('EPUB_READWISE_TOKEN')
        EPUB_FTP_PASS = credentials('EPUB_FTP_PASS')
        GAS_ENDPOINT_EPUBS_PROCESSED_TRACKER = credentials('GAS_ENDPOINT_EPUBS_PROCESSED_TRACKER')
        GAS_UPLOAD_EPUB_ENDPOINT = credentials('GAS_UPLOAD_EPUB_ENDPOINT')
        // App-specific variables
        // No extra app params needed for this script
    }

    options {
        // Standard Jenkins options for job management
        buildDiscarder(logRotator(numToKeepStr: '20'))
        timeout(time: 60, unit: 'MINUTES')
        timestamps()
    }

    stages {
        stage('Checkout') {
            steps {
                // Checkout the repository from which the Jenkinsfile is executed
                checkout scm
            }
        }

        stage('Install System Dependencies') {
            steps {
                sh '''
                    #!/usr/bin/env bash
                    set -eux
                    export DEBIAN_FRONTEND=noninteractive
                    
                    # Update package list and install necessary system tools
                    apt-get update
                    apt-get install -y --no-install-recommends \
                        sudo python3 python3-pip python3-venv \
                        wget build-essential
                '''
            }
        }

        stage('Setup Python Environment') {
            steps {
                sh '''
                    #!/usr/bin/env bash
                    set -eux

                    # Create and activate a Python virtual environment
                    python3 -m venv venv
                    . venv/bin/activate
                    
                    # Install Python dependencies from the requirements file
                    pip install -r readwise_to_epub/requirements.txt
                '''
            }
        }
        
        stage('Install kepubify') {
            steps {
                sh '''
                    #!/usr/bin/env bash
                    set -eux

                    # Download kepubify
                    wget https://github.com/pgaskin/kepubify/releases/download/v4.0.4/kepubify-linux-64bit

                    # Make the file executable and move to a system-wide PATH location
                    chmod +x kepubify-linux-64bit
                    sudo mv kepubify-linux-64bit /usr/local/bin/kepubify

                    # Verify installation
                    kepubify --version
                '''
            }
        }

        stage('Run Script') {
            steps {
                sh '''
                    #!/usr/bin/env bash
                    set -eux
                    
                    # Activate the virtual environment
                    . venv/bin/activate

                    # Run the main Python script
                    python3 readwise_to_epub/readwise_to_epub.py
                '''
            }
        }
    }
}